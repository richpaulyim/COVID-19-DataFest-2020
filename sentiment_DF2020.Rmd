---
title: "COVID-19 Sentiment Analysis"
author: "Cassandra, Susan, Vicki, Emily and Richard"
date: "5/13/2020"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Reading in Cleaned Data and Basic Reformatting
```{r}
headlines <- read.csv("data/news_clean.csv")

# Names of variables
names(headlines)

# Load all of the data into the working environment
attach(headlines)
# We ignore the id, timestamp and source, and focus on the title, description and date
headlines <- data.frame(title, description, date)
# Reformat and separate year month and day
headlines$month = substr(date, 6, 7)
headlines$day <- substr(date, 9, 10)
attach(headlines)
```
We want to check how many days there are in the dataset:
```{R}
begin <- headlines$date[1]
end <- headlines$date[length(headlines$date)]
days <- as.Date(end) - as.Date(begin)
days
cat(begin, end)
```

## Frequency of Strings
```{r}
library("ggplot2") #beautiful plots
library("reshape2") #melt-function

plot_word_in_day <- function(phrase){
  freq <- NULL
  days <- unique(headlines$date)
    for(day in days)
    {
      matching_day <- headlines$title[headlines$date == day]
      freq[length(freq)+1] <- sum(grepl(phrase, matching_day, ignore.case = FALSE))
    }
  return(freq)
}

list <- c("recession", "downturn", "covid-19", "trump")
time <- data.frame(seq(as.Date("2020-03-21"),by="day",length.out=53))

# turn off warnings temporarily
options(warn=-1)
for(i in list)
{
  val <- plot_word_in_day(i)
  time <- cbind(time, val)
}
options(warn = 0)

colnames(time) <- c("date", list)
charts <- melt(time, id="date")
names(charts) <- c('x', 'func', 'value')

g=ggplot() +
  geom_line(data = charts, aes(x = x, y = value, color = func),size=1) +
  xlab("year") +
  ylab("frequency")
g+scale_color_manual(values=c("#FF0000", "#FF00D0","#0007FF","#09FF00"))
```

## Sentiment Analysis
```{r}
library(tidytext)
library(ggplot2)
library(lubridate) # month and year function
library(data.table) # for the inner join

pos_neg <- get_sentiments("afinn")
pos_neg$X1 <- factor(pos_neg$word)
pos_neg$word <- NULL
pos_neg <- data.frame(pos_neg)

result <- data.frame(matrix(ncol = 2, nrow = 0))

days <- unique(headlines$date)
score <- NULL
options(warn=-1)
for(day in days){
  # select words in day
  words_in_day <- data.frame(headlines$title[headlines$date == day])
  # split words 
  h <- apply(words_in_day, MARGIN=1, function(x) strsplit(as.character(x)," "))
  X1 <- unlist(h, recursive = F)
  xtab <- data.frame(X1)
  print(dim(xtab))
  print(dim(pos_neg))
  h2 <- left_join(xtab, pos_neg, by = "X1")
  h2[is.na(h2)] <- 0
  score[length(score) + 1] <- sum(h2[,2])
}
options(warn=1)

#g1=ggplot() +
#  geom_line(data = sent, aes(x = x, y = value),size=1) +
#  xlab("day") +
#  ylab("sentiment")
```
## Looking at the Data
We have a time-series on the sentiment from coronavirus related news.
```{R}
sent
```